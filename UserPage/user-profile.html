<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="css/table.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&amp;display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Cabin:400,500,600,700&display=swap" rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="css/flaticon.css" type="text/css">
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="css/nice-select.css" type="text/css">
    <link rel="stylesheet" href="css/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="css/style.css" type="text/css">
    <link rel="stylesheet" href="css/header.css" type="text/css">
    <style>
        .navbar.active {
            font-weight: 600;
            --tw-text-opacity: 1;
            color: #ff6400;
            color: rgb(255 100 0 / var(--tw-text-opacity));
        }
    </style>
</head>

<body>
    <header class="header-section">
        <div class="menu-item">
            <div class="container">
                <div class="row">
                    <div class="col-lg-2">
                        <div class="logo">
                            <a href="./index.html">
                                <img src="img/logo.png" alt="" />
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="nav-menu">
                            <nav class="mainmenu">
                                <ul>
                                    <li class="active"><a href="./index.html">Trang Chủ</a></li>
                                    <li><a href="./rooms.html">Homestay</a></li>
                                    <li><a href="./about-us.html">Về chúng tôi</a></li>
                                    <li><a href="./contact.html">Liên hệ</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                    <div class="col-lg-4 d-flex">
                        <div class="login" style="width: 90%;">
                            <a href="guest-sign-in.html" class="bk-btn" id="btnLogin">Đăng Nhập</a>
                        </div>
                        <div class="profile justify-content-end" id="userProfile" style="display: none">
                            <div class="img-box">
                                <img src="https://i.postimg.cc/BvNYhMHS/user-img.jpg" alt="some user image" />
                            </div>
                        </div>
                        <div class="menu">
                            <ul>
                                <li>
                                    <a href="user-profile.html"><i class="ph-bold ph-user"></i>&nbsp;Profile</a>
                                </li>
                                <li>
                                    <a href="#"><i class="ph-bold ph-envelope-simple"></i>&nbsp;Inbox</a>
                                </li>
                                <li>
                                    <a href="#"><i class="ph-bold ph-gear-six"></i>&nbsp;Settings</a>
                                </li>
                                <li>
                                    <a href="#"><i class="ph-bold ph-question"></i>&nbsp;Help</a>
                                </li>
                                <li>
                                    <a onclick="logout()"><i class="ph-bold ph-sign-out"></i>&nbsp;Sign Out</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div id="app">
        <div class="flex items-start flex-row pb-20 h-screen">
            <div class="flex flex-col flex-1" id="nav-user-profile">
                <div class="768:mt-32 flex flex-col justify-between relative">
                    <div class="flex items-start flex-row pb-20 px-32">
                        <!-- navbar content -->
                        <div
                            class="w-[370px] p-24 pt-24 pb-72 top-30 flex flex-col h-fit border-solid border border-gray-20 rounded-16 mr-32 sticky">
                            <div class="768:text-center px-16 py-24 text-left flex items-center 768:flex-col"  id="append-img">
                                <div id="user-avatar"
                                    class="768:mx-auto my-0 w-[100px] h-[100px] border border-dashed border-gray-30 rounded-round flex items-center justify-center p-4">
                                    <input type="file" name="file-1[]" id="file-1" class="inputfile"
                                        data-multiple-caption="{count} files selected" multiple />
                                    <label for="file-1" class="m-0">
                                        <i class="zmdi zmdi-camera"></i>
                                        <span>Choose Picture</span>
                                    </label>
                                </div>
                            </div>
                            <div onclick="getUserByUserId()" href="#nav-profile-content"
                                class="navbar 768:px-24 py-10 px-16 hover:text-primary hover:bg-gray-10 rounded-8 cursor-pointer text-title-medium flex items-center justify-between active">
                                <div class="flex items-center">
                                    <span>Hồ sơ
                                        của tôi</span>
                                </div>
                            </div>
                            <div onclick="getBookingsByUserId()" href="#nav-booking-content"
                                class="navbar 768:px-24 py-10 px-16 hover:text-primary hover:bg-gray-10 rounded-8 cursor-pointer text-title-medium flex items-center justify-between">
                                <div class="flex items-center">
                                    <span>Lịch sử
                                        đặt phòng</span>
                                </div>
                            </div>
                            <div href="#nav-wallet-content"
                                class="navbar 768:px-24 py-10 px-16 hover:text-primary hover:bg-gray-10 rounded-8 cursor-pointer text-title-medium flex items-center justify-between">
                                <div class="flex items-center">
                                    <span>Ví của tôi</span>
                                </div>
                            </div>

                            <hr class="text-gray-20 my-16 mt-[148px]">
                            <div
                                class="navbar account__sidebar--bottom flex items-center cursor-pointer hover:text-primary px-24 text-title-medium">
                                <a><span>Đăng xuất</span></a>
                            </div>
                        </div>


                        <!-- Main content -->
                        <div class="flex flex-col flex-1" id="nav-profile-content">

                            <!-- Profile information -->
                            <div
                                class="768:flex-row flex-col flex 768:items-center border-b text-body-large 768:h-60 border-solid border-gray-20 py-8">
                                <label class="768:w-1/5 w-full mb-4 768:mb-0 text-body-large" for="number">Số điện
                                    thoại</label>
                                <p id="phoneNumber" class="font-bold text-gray-80"></p>
                            </div>

                            <div
                                class="768:flex-row flex-col flex 768:items-center border-b text-body-large 768:h-60 border-solid border-gray-20 py-8">
                                <label class="768:w-1/5 w-full mb-4 768:mb-0 text-body-large" for="nickName">Họ Và
                                    Tên</label>
                                <p id="guestName" class="font-bold text-gray-80"></p>
                            </div>

                            <div
                                class="768:flex-row flex-col flex 768:items-center border-b text-body-large 768:h-60 border-solid border-gray-20 py-8">
                                <label class="768:w-1/5 w-full mb-4 768:mb-0 text-body-large" for="email">Email</label>
                                <p id="UserEmail" class="font-bold text-gray-80"></p>
                            </div>

                            <div
                                class="768:flex-row flex-col flex 768:items-center border-b text-body-large 768:h-60 border-solid border-gray-20 py-8">
                                <label class="768:w-1/5 w-full mb-4 768:mb-0 text-body-large" for="card">Căn Cước Công
                                    Dân</label>
                                <p id="GuestCccd" class="font-bold text-gray-80"></p>
                            </div>

                            <div
                                class="768:flex-row flex-col flex 768:items-center border-b text-body-large 768:h-60 border-solid border-gray-20 py-8">
                                <label class="768:w-1/5 w-full mb-4 768:mb-0 text-body-large" for="address">Địa
                                    Chỉ</label>
                                <p id="GuestAddress" class="font-bold text-gray-80"></p>
                            </div>
                            <div
                                class="768:flex-row flex-col flex 768:items-center text-body-large 768:h-60 py-8">
                                <button class="btn btn-outline-primary" onclick="editFields()">Chỉnh sửa</button>
                                <button class="btn btn-outline-primary" onclick="updateGuest()" style="margin: 50px;">Lưu</button>
                            </div>

                        </div>

                        <div class="hidden" id="nav-booking-content">
                            <div
                                class="flex 768:items-center items-end 768:justify-between justify-end mb-32 768:flex-row flex-col">
                                <h2 class="title text-h1 font-bold 768:text-40 text-left w-full 768:w-auto">Lịch sử đặt
                                    phòng</h2>

                            </div>
                            <div>
                                <table id="tbl_history">
                                    <tr>
                                        <th style="width: 5%;">STT</th>
                                        <th style="width: 10%;">Mã phòng</th>
                                        <th>Tên phòng</th>
                                        <th>Số tiền</th>
                                        <th>Check In</th>
                                        <th>Check Out</th>
                                        <th>Trạng Thái</th>
                                        <th style="width: 15%;"></th>
                                    </tr>
                                    <!-- <tr>
                                        <td>1</td>
                                        <td>P1</td>
                                        <td>Phòng số 1</td>
                                        <td>1.000.000VNĐ</td>
                                        <td>23/03/2024</td>
                                        <td>25/03/2024</td>
                                        <td>Booked</td>
                                        <td class="text-center text-white"><a class="btn btn-danger">Hủy Phòng</a></td>
                                    </tr> -->
                                </table>
                            </div>
                        </div>
                        <div class="hidden" id="nav-wallet-content">
                            <div
                                class="flex 768:items-center items-end 768:justify-between justify-end mb-32 768:flex-row flex-col">
                                <h2 class="title text
                            -h1 font-bold 768:text-40 text-left w-full 768:w-auto">Ví của tôi</h2>
                            </div>
                        </div>
                        <div class="hidden" id="nav-logout-content">
                            <div
                                class="flex 768:items-center items-end 768:justify-between justify-end mb-32 768:flex-row flex-col">
                                <h2 class="title text
                            -h1 font-bold 768:text-40 text-left w-full 768:w-auto">Đăng xuất</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col flex-1 hidden" id="nav-item-1"> Nav Item 1</div>
            <div class="flex flex-col flex-1 hidden" id="nav-item-2"> Nav Item 2</div>
            <div class="flex flex-col flex-1 hidden" id="nav-item-3"> Nav Item 3</div>
        </div>
    </div>


    <script src="./js/jquery-3.3.1.min.js"></script>
    <script src="./js/header.js"></script>
    <script src="./js/sign-out.js"></script>
    <script>
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
        // Hàm để hiển thị thông tin khách hàng khi trang được load
        window.onload = function () {
            // Mô phỏng dữ liệu khách hàng
            const customerData = {
                guestPhone: "",
                guestName: "",
                guestEmail: "",
                guestCccd: "",
                guestAddress: ""
            };
            // Hiển thị thông tin khách hàng
            displayCustomerInfo(customerData);
        };

        // Hàm để hiển thị thông tin khách hàng
        function displayCustomerInfo(customerData) {
            document.getElementById("phoneNumber").textContent = customerData.guestPhone;
            document.getElementById("guestName").textContent = customerData.guestName;
            document.getElementById("UserEmail").textContent = customerData.guestEmail;
            document.getElementById("GuestCccd").textContent = customerData.guestCccd;
            document.getElementById("GuestAddress").textContent = customerData.guestAddress;
        }

        function editFields() {
            // Mã bạn đã cung cấp được chỉnh sửa ở đây
            const fieldMap = {
                phoneNumber: "guestPhone",
                guestName: "guestName",
                UserEmail: "guestEmail",
                GuestCccd: "guestCccd",
                GuestAddress: "guestAddress"
            };
            Object.entries(fieldMap).forEach(([pElementId, inputElementId]) => {
                const pElement = document.getElementById(pElementId);
                const inputElement = document.createElement("input");
                inputElement.id = inputElementId;
                inputElement.type = "text";
                inputElement.value = pElement.textContent.trim(); // Use trim() to remove unnecessary whitespaces
                pElement.replaceWith(inputElement);
            });
        }

        // Hàm để gửi yêu cầu cập nhật thông tin khách hàng
        function updateGuest() {
            // Sửa đổi để lấy giá trị từ các input thay vì textContent
            const id = getCookie("UserId"); // Hãy thay thế bằng id thực tế của khách hàng
            const phone = document.getElementById("guestPhone").value;
            const name = document.getElementById("guestName").value;
            const email = document.getElementById("guestEmail").value;
            const cccd = document.getElementById("guestCccd").value;
            const address = document.getElementById("guestAddress").value;

            const url = `https://localhost:44375/api/Guests/updateUser`;

            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    guestId: id,
                    guestPhone: phone,
                    guestName: name,
                    guestEmail: email,
                    guestCccd: cccd,
                    guestAddress: address
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Thông tin khách hàng đã được cập nhật:', data);
                    // Xử lý dữ liệu trả về nếu cần
                })
                .catch(error => {
                    console.error('Có lỗi xảy ra khi gửi yêu cầu cập nhật:', error);
                    // Xử lý lỗi nếu cần
                });
        }

    </script>
    <script>
        $(document).ready(function () {

            function toggleEditMode(isEditMode) {
                if (isEditMode) {
                    $('.edit-mode').removeClass('hidden');
                    $('.view-mode').addClass('hidden');
                } else {
                    $('.edit-mode').addClass('hidden');
                    $('.view-mode').removeClass('hidden');
                }
            }

            // mặc định ở chế độ xem
            toggleEditMode(false);


            // xử lý khi nhấn nút chỉnh sửa
            $('#editProfile').click(function () {
                $(this).addClass('hidden');
                $('#editContainer').removeClass('hidden');
                toggleEditMode(true);
            });

            // xử lý khi nhấn nút lưu
            $('#saveProfile').click(function () {
                $('#editProfile').removeClass('hidden');
                $('#editContainer').addClass('hidden');
                toggleEditMode(false);
            });

            // xử lý khi nhấn nút huỷ
            $('#cancelProfile').click(function () {
                $('#editProfile').removeClass('hidden');
                $('#editContainer').addClass('hidden');
                toggleEditMode(false);
            });

            // Xử lý ẩn hiện navbar
            $('.navbar[href^="#"]').on('click', function (e) {
                var id = $(this).attr('href');
                var activeId = $('.navbar.active').attr('href');
                $('.navbar').removeClass('active');
                $(this).addClass('active');
                $(activeId).addClass('hidden');
                $(id).removeClass('hidden');
            });

            $('#sidebar').on('click', 'a', function (e) {
                var id = $(this).attr('href');
                var activeLi = $('#sidebar li.active');
                var activeLiId = activeLi.find('a').attr('href');
                // lấy ra li đang active
                if (id !== activeLiId) {
                    activeLi.removeClass('active');
                    $(this).parent().addClass('active');
                    $(activeLiId).addClass('hidden');
                    $(id).removeClass('hidden');
                }
            });

        });
    </script>
    <script>
        window.onload = function getUserByUserId() {
            const userId = getCookie("UserId");
            console.log(userId);
            fetch(`https://localhost:44375/api/Guests/${userId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    var tbl_content = document.getElementById('UserInfo');
                    document.getElementById("phoneNumber").textContent = data.guestPhone;
                    document.getElementById("guestName").textContent = data.guestName;
                    document.getElementById("UserEmail").textContent = data.guestEmail;
                    document.getElementById("GuestCccd").textContent = data.guestCccd;
                    document.getElementById("GuestAddress").textContent = data.guestAddress;
                    const tableBody = document.getElementById("append-img");
                    const avatar = document.getElementById("user-avatar");
                    avatar.style.display ="none";
                    // tableBody.style.backgroundImage = "data:image/jpg;base64," + data.guestAvatar;
                    const row = document.createElement("img");
                    row.setAttribute("src", "data:image/jpg;base64," + data.guestAvatar);
                    tableBody.prepend(row);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

    </script>
    <script>
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
        let isLoaded = false;
        async function getBookingsByUserId() {
            if (isLoaded) return;
            try {
                const userId = getCookie("UserId");
                const response = await fetch(`https://localhost:44375/api/Booking/booking_history?userId=${userId}`);
                const data = await response.json();
                // console.table(data);
                const tbl_content = document.getElementById("tbl_history");
                var i = 1;
                for (const item of data) {
                    await fetch(`https://localhost:44375/api/Homestays/${item.homstayId}`)
                        .then(response => response.json())
                        .then(homestay => {
                            homestay.forEach(home => {
                                const row = document.createElement("tr");

                                const checkinTime = new Date(item.bookingFrom);
                                const checkoutTime = new Date(item.bookingTo);
                                const now = new Date();
                                const checkinTimePlus5Days = new Date(checkinTime);
                                checkinTimePlus5Days.setDate(now.getDate() + 0);
                                // console.log(checkinTimePlus5Days);

                                if (checkinTime >= checkinTimePlus5Days) {
                                    row.innerHTML = `
                                    <td>${i}</td>
                                    <td>${item.homstayId}</td>
                                    <td>${home.homestayName}</td>
                                    <td>${item.totalCost}</td>
                                    <td>${checkinTime.toDateString()}</td>
                                    <td>${checkoutTime.toDateString()}</td>
                                    <td>${home.homestayName}</td>
                                    <button class="text-center text-white btn btn-danger" onclick="deleteBooking(this)" data-value="${item.bookingId}">Hủy Phòng</button>
                                `;
                                    tbl_content.appendChild(row);
                                } else {
                                    row.innerHTML = `
                                    <td>${i}</td>
                                    <td>${item.homstayId}</td>
                                    <td>${home.homestayName}</td>
                                    <td>${item.totalCost}</td>
                                    <td>${checkinTime.toDateString()}</td>
                                    <td>${checkoutTime.toDateString()}</td>
                                    <td>${home.homestayName}</td>`;
                                    tbl_content.appendChild(row);
                                }
                                i++;
                            });
                        });
                }
                isLoaded = true;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        $(document).ready(function () {
            const userId = getCookie("UserId");
            $.ajax({
                url: `https://localhost:44375/Transaction/wallet/${userId}`,
                type: 'GET',
                dataType: 'json', // hoặc 'html' nếu data trả về không phải JSON
                success: function (data) {
                    // Xử lý dữ liệu khi nhận về thành công
                    $('#result').html('Số dư trong ví của bạn: ' + data.amount + 'VNĐ');
                },
                error: function (xhr, status, error) {
                    // Xử lý khi gặp lỗi trong quá trình AJAX
                    console.log('Lỗi: ' + error);
                }
            });
        });

    </script>

    <script>
        // window.onload = function(){ 
        function deleteBooking(e) {
            event.preventDefault();
            const userId = getCookie("UserId");
            var id = e.getAttribute('data-value');
            // Thực hiện AJAX request ở đây
            var xhr = new XMLHttpRequest();
            xhr.open('POST', `https://localhost:44375/api/Booking/delete/${id}/${userId}`, true);
            xhr.onload = function () {
                if (xhr.status >= 200 && xhr.status < 300) {
                    location.reload();
                } else {
                    console.error('Yêu cầu AJAX bị lỗi.');
                }
            };
            xhr.send();
        };
        // }
    </script>
</body>

</html>